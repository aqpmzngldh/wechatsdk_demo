<!DOCTYPE html>
<html lang="en">
<head>
    <title>微信分享示例</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no,minimal-ui">
    <link rel="icon" href="./../images/favico.ico">
    <!--不同屏幕尺寸根字体设置-->
    <script src="./../js/base.js"></script>
    <!--element-ui的样式-->
    <link rel="stylesheet" href="../../backend/plugins/element-ui/index.css"/>
    <!--引入vant样式-->
    <link rel="stylesheet" href="../styles/vant.min.css"/>
    <!-- 引入样式  -->
    <!--<link rel="stylesheet" href="../styles/index.css"/>-->
    <!--本页面内容的样式-->
    <link rel="stylesheet" href="./../styles/login.css"/>
</head>
<body>
<div id="app">
    <h1>123</h1>
    <button @click="location">按钮通过jssdk获取位置</button>
    <button @click="pay">测试微信支付</button>
    <button @click="pdf">测试图片转pdf</button>
</div>

<script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>

<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="../../backend/plugins/vue/vue.js"></script>
<!-- 引入组件库 -->
<script src="../../backend/plugins/element-ui/index.js"></script>
<!-- 引入vant样式 -->
<script src="./../js/vant.min.js"></script>
<!-- 引入axios -->
<script src="../../backend/plugins/axios/axios.min.js"></script>
<script src="./../js/request.js"></script>
<script src="./../api/login.js"></script>
<script>
    new Vue({
        el: '#app',
        mounted() {
            let getNonceStr=this.generateNonceStr(8);
            const timestamp = Date.now().toString();
            let signature;
            $axios.post("/wx/signature/" + getNonceStr + '/' + timestamp)
                .then((res) => {
                    console.log(res)
                    signature=res;
                    // 初始化微信JS-SDK
                    wx.config({
                        debug: true,
                        appId: 'wx61c514e5d83894bf',
                        timestamp: timestamp,
                        nonceStr: getNonceStr,
                        signature: signature,
                        jsApiList: ['getLocation','chooseImage','uploadImage']
                    });
                })
                .catch(err => {
                    console.error(err); // 输出错误信息
                    this.$notify({type: 'warning', message: '程序出错'});
                });


        },

        methods:{
            pay(){
                let getNonceStr=this.generateNonceStr(8);
                const timestamp = Date.now().toString();
                $axios.post("/api/wx-pay/jsapi/" + getNonceStr+"/"+timestamp+"/"+1)
                    .then((res) => {
                        // alert(JSON.stringify(res));
                        console.log(res.map);
                        console.log(res.map.bodyAsString);
                        console.log(res.map.paySign);
                        WeixinJSBridge.invoke('getBrandWCPayRequest', {
                            "appId": "wx61c514e5d83894bf",     //公众号ID，由商户传入
                            "timeStamp": timestamp,     //时间戳，自1970年以来的秒数
                            "nonceStr": getNonceStr,      //随机串
                            "package": "prepay_id="+res.map.bodyAsString,
                            "signType": "RSA-SHA256",     //微信签名方式：
                            "paySign": res.map.paySign //微信签名
                        })
                    })
                    .catch(err => {
                        console.error(err); // 输出错误信息
                        this.$notify({type: 'warning', message: '程序出错'});
                    });
            },
            pdf(){
                wx.chooseImage({
                    count: 1, // 默认9
                    sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                    sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                    success: function (res) {
                        var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                    if(localIds.length>1){
                        alert(localIds.length);
                    }
                        wx.uploadImage({
                            localId: localIds, // 需要上传的图片的本地ID，由chooseImage接口获得
                            isShowProgressTips: 1, // 默认为1，显示进度提示
                            success: function (res) {
                                var serverId = res.serverId; // 返回图片的服务器端ID

alert(serverId)
                            }
                        });
                    }
                });
            },
            location(){
                wx.getLocation({
                    type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                    success: function (res) {
                        var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                        var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                        var speed = res.speed; // 速度，以米/每秒计
                        var accuracy = res.accuracy; // 位置精度
                        console.log(latitude,longitude,speed,accuracy)
                    }
                });
            },

            generateNonceStr(length) {
                const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let nonceStr = '';
                for (let i = 0; i < length; i++) {
                    nonceStr += chars[Math.floor(Math.random() * chars.length)];
                }
                return nonceStr;
            }
        }
    });
</script>
</body>
</html>
